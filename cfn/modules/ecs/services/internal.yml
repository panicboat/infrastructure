AWSTemplateFormatVersion: 2010-09-09

Parameters:
  ProjectName:
    Type: String
  ClusterArn:
    Type: String
  DesiredCount:
    Type: Number
  NamespaceId:
    Type: String
  ProtectSubnets:
    Type: List<AWS::EC2::Subnet::Id>
  SecurityGroups:
    Type: List<AWS::EC2::SecurityGroup::Id>
  TaskDefinitionArn:
    Type: String

Resources:
  ServiceDiscovery:
    Type: AWS::ServiceDiscovery::Service
    Properties:
      HealthCheckCustomConfig:
        FailureThreshold: 1
      DnsConfig:
        DnsRecords:
          - Type: A
            TTL: 60
        NamespaceId: !Ref NamespaceId
      Name: !Ref ProjectName

  Service:
    Type: AWS::ECS::Service
    Properties:
      Cluster: !Ref ClusterArn
      DesiredCount: !Ref DesiredCount
      LaunchType: FARGATE
      NetworkConfiguration:
        AwsvpcConfiguration:
          AssignPublicIp: ENABLED   # TODO: Set to DISABLED when using NAT Gateway
          SecurityGroups: !Ref SecurityGroups
          Subnets: !Ref ProtectSubnets
      ServiceName: !Ref ProjectName
      ServiceRegistries:
        - RegistryArn: !GetAtt ServiceDiscovery.Arn
      TaskDefinition: !Ref TaskDefinitionArn
